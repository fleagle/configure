<?php
require_once('config.php');
if(err_switch == true)
{
	error_reporting(E_ALL);
	ini_set('display_errors','On');
}

require_once('public.php');
require_once('function_redis.php');
require_once('cacheManager.class.php');

$cacheManager = new CacheManager();
$sredis = new Redis();
$sredis->pconnect(slaveredisip,slaveredisport);

//get post data
if(isset($GLOBALS['HTTP_RAW_POST_DATA']))
{
	loginfo('Request',$_SERVER,$GLOBALS['HTTP_RAW_POST_DATA']);
	
	$request = json_decode($GLOBALS['HTTP_RAW_POST_DATA']);
	
	if(isset($request->method))
	{
		$method = $request->method;
	}else{
		loginfo('Response','127.0.0.1','{"jsonrpc":"2.0","error":{"code":-32700,"message":"json method format is not correct","data":"Invalid JSON. An error occurred on the server while parsing the JSON text."}}');
		echo '{"jsonrpc":"2.0","error":{"code":-32700,"message":"json method format is not correct","data":"Invalid JSON. An error occurred on the server while parsing the JSON text."}}';exit;
	}
	
	if(isset($request->params))
	{
		$params = $request->params;
	}else{
		loginfo('Response','127.0.0.1','{"jsonrpc":"2.0","error":{"code":-32700,"message":"json method format is not correct","data":"Invalid JSON. An error occurred on the server while parsing the JSON text."}}');
		echo '{"jsonrpc":"2.0","error":{"code":-32700,"message":"json params format is not correct","data":"Invalid JSON. An error occurred on the server while parsing the JSON text."}}';exit;
	}
	
	$email = '';
	if(isset($params->email))
	{
		$email = $params->email;
	}
	
	$password = '';
	if(isset($params->password))
	{
		$password = $params->password;
	}
	
	$token = '';
	$devicesn = '';
	
	if(isset($params->devicesn))
	{
		$devicesn = $params->devicesn;
	}
//	$devicetype = '2';//device type 1-android phone 2-android pad 3-iphone 4-ipad 5-webapp 6-resounce
}else{
	loginfo('Response','127.0.0.1','{"jsonrpc":"2.0","error":{"code":-32700,"message":"json method format is not correct","data":"Invalid JSON. An error occurred on the server while parsing the JSON text."}}');
	echo '{"jsonrpc":"2.0","error":{"code":-32700,"message":"Parse Error","data":"Invalid JSON. An error occurred on the server while parsing the JSON text."}}';exit;
}

if(ftenv == true)
{
	$applicationenv = unserialize($sredis->get('applicationenv'));
	$cpicvideo = unserialize($sredis->get('cpicvideo'));
//$applicationenv = $cacheManager->getValue('applicationenv');
//$cpicvideo = $cacheManager->getValue('cpicvideo');
	if(empty($applicationenv) || empty($cpicvideo))
	{
		dboperate(0);
		dboperate(7);
		dboperate(8);
	}
	if(!empty($email))
	{
		$userinfo = unserialize($sredis->get('userinfo'.$email));
		$usersession = unserialize($sredis->get('usersession'.$email));
//$userinfo = $cacheManager->getValue('userinfo'.$email);
//$usersession = $cacheManager->getValue('usersession'.$email);
		if(empty($userinfo) || empty($usersession))
		{
			dboperate(1,array('email'=>$email));dboperate(2,array('email'=>$email));
		}
		
		$usersession = unserialize($sredis->get('usersession'.$email));
//$usersession = $cacheManager->getValue('usersession'.$email);
		if(empty($userinfo) || empty($usersession))
		{
			dboperate(2,array('email'=>$email));
		}
	}
	if(!empty($devicesn))
	{
		$devicesnredis = unserialize($sredis->get('devicelist'.$devicesn));
//$devicesnredis = $cacheManager->getValue('devicelist'.$devicesn);
		if(empty($devicesnredis))
		{
			dboperate(4,array('devicesn'=>$devicesn));
		}
	}
}
//business
$response = array('jsonrpc'=>'2.0','id'=>1,"result"=>array());
require_once('interface_redis.php');

?>