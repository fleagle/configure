<?php
function GetIP($serv){
    if($serv == '127.0.0.1'){return $serv;}
	if(!empty($serv["HTTP_CLIENT_IP"])){
      $cip = $serv["HTTP_CLIENT_IP"];
    }
    elseif(!empty($serv["HTTP_X_FORWARDED_FOR"])){
      $cip = $serv["HTTP_X_FORWARDED_FOR"];
    }
    elseif(!empty($serv["REMOTE_ADDR"])){
      $cip = $serv["REMOTE_ADDR"];
    }
    else{
      $cip = "无法获取！";
    }
    return $cip;
}

function loginfo($req,$server,$info,$way = 'file')
{
	if(logswitch)
	{
		$deviceip = '';
		if(!empty($server))
		{
			$deviceip = GetIP($server);
		}
		$endtime = strtotime('now');
		$costtime = $endtime - starttime;
		$row = array('psk'=>'CPIC_LOG_PSK_SEQ.nextval','deviceip'=>$deviceip,'way'=>$req,'logmsg'=>'本接口耗时：'.$costtime.'s,请求报文：'.$info);
		if($way == 'db')
		{
			dboperate(array(),2,array('op'=>'insert','table'=>'tracking.cpic_log','row'=>$row));
		}else{
			$infostatue = '';
			$find = strpos($info,'com.apperian.easesdk.authenticateuser');if($find){$infostatue = 'login';}
			$find = strpos($info,'com.apperian.easesdk.authenticateserver');if($find){$infostatue = 'sso';}
			$find = strpos($info,'com.apperian.easesdk.deviceversion');if($find){$infostatue = 'deviceversion';}
			$find = strpos($info,'com.apperian.easesdk.videolist');if($find){$infostatue = 'videolist';}
			$find = strpos($info,'com.apperian.eas.apps.getapplicationbyname');if($find){$infostatue = 'singleapp';}
			$find = strpos($info,'com.apperian.easesdk.getusercard');if($find){$infostatue = 'mycard';}
			$find = strpos($info,'com.apperian.easesdk.getapplicationenv');if($find){$infostatue = 'appenv';}
			$find = strpos($info,'com.apperian.eas.apps.getallapplications');if($find){$infostatue = 'applist';}
			$find = strpos($info,'com.apperian.easesdk.edituser');if($find){$infostatue = 'edituser';}
			$find = strpos($info,'com.apperian.easesdk.devicesync');if($find){$infostatue = 'deivcesync';}
			switch($infostatue)
			{
				case 'login':
					$color = '#FF3300';
					break;
				case 'sso':
					$color = '#FFCC00';
					break;
				case 'deviceversion':
					$color = '#FF66CC';
					break;
				case 'videolist':
					$color = '#66FF33';
					break;
				case 'singleapp':
					$color = '#666666';
					break;
				case 'mycard':
					$color = '#3366FF';
					break;
				case 'appenv':
					$color = '#00FF99';
					break;
				case 'applist':
					$color = '#CC66CC';
					break;
				case 'edituser':
					$color = '#3366FF';
					break;
				case 'deivcesync':
					$color = '#9933CC';
					break;
				default:
					$color = '#000000';
					break;
			}
			$firstinsert = '';
			if(!file_exists(logurl . 'log'.date('Ymd').'.htm'))
			{
				$firstinsert = '
				<input type="button" name="button2" id="button2" value="返回" onclick="history.back(-1);"/>　　<input type="button" name="button2" id="button2" value="刷新" onclick="location.reload();"/>　　<input type="button" name="button2" id="button2" value="底部" onclick="window.scrollTo(0,window.document.height);"/></div></br>';
			}
			file_put_contents(logurl . 'log'.date('Ymd').'.htm',$firstinsert."\r\n".'<hr /><font color="#FF0000">'.date('Y-m-d H:i:s').'</font>|<font color="#0000FF">'.$deviceip.'</font>|<font color="#00FF00">'.$req.'</font>|<font color="'.$color.'">'.$info.'</font>|<font color="#FF00FF">本接口耗时：'.$costtime.'s'.'</font><br/>'."\r\n",FILE_APPEND);
		}
	}
}
?>